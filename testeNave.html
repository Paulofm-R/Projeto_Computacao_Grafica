<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <title>INTERACTIONS</title>
    <style>
        body{
            margin:0;
            padding:0;
            cursor:crosshair; 
            background-color: black;
        }
    </style>
</head>

<body>
    <canvas id="canvas" style="border:solid 1px green">
        Your browser does not support HTML5 Canvas.
    </canvas>

    <script>
        const canvas = document.querySelector("#canvas");
        const ctx = canvas.getContext("2d");

        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight + 20

        const W = canvas.width;
        const H = canvas.height;

        let x = W / 2;
        let y = H / 2;

        //circle properties
        ctx.fillStyle = "blue";
        const R = 20;

        //setas
        let upKey = false;
        let downKey = false;
        let leftKey = false;
        let rightKey = false;
        let space = false;

        let spaceTimer = 0;
        let timer

        //rato
        let click = false;  
        let xR;
        let yR;

        //tiros
        let tiroTimer = true;
        let timeTiro

        //imagens
        let imagens = {}
        loadImage('Nave');
        loadImage("Meteoro 1");
        loadImage("Meteoro 2");
        loadImage("Meteoro 3");
        loadImage("Meteoro 4");

        function loadImage(name){
            imagens[name] = new Image();
            imagens[name].src = 'img/' + name + '.png';
        }

        function KeyPressed(e){
            if (e.key == 'w'){
                upKey = true;
            }
            if (e.key == 's'){
                downKey = true;
            }
            if (e.key == 'a'){
                leftKey = true;
            }
            if (e.key == 'd'){
                rightKey = true;
            }
            if (e.key == ' ' && spaceTimer == 0){
                space = true;
                spaceTimer = 5;
                timer = window.setInterval(teleportTimer, 1000);
            }
            if (e.key == 'Enter'){
                render();
                fullscreen();
            }
        }

        function KeyReleased(e){
            switch (e.key){
                case "w":
                    upKey = false; ;
                    break;
                case "s":
                    downKey = false;
                    break;
                case "a":
                    leftKey = false;
                    break;
                case "d":
                    rightKey = false;
                    break;
                case ' ':
                    space = false;
                    break;
            }
        }

        window.addEventListener('keydown', KeyPressed);
        window.addEventListener('keyup', KeyReleased);
        
        function teleport(){
            x = Math.floor(Math.random() * (canvas.width - 2*R) + R);
            y = Math.floor(Math.random() * (canvas.height - 2*R) + R);
        }

        function teleportTimer(){
            console.log(spaceTimer);
            spaceTimer--;
            if (spaceTimer == 0){
                clearInterval(timer);
            }
        }

        //asteroides
        class Asteroides{
            constructor(x, y, r, d, c){
                this.x = x;
                this.y = y;
                this.dX = 2 * Math.cos(d);
                this.dY = 2 * Math.sin(d);
                this.R = r;
                this.c = c;
            }

            draw(){
                ctx.fillStyle = 'White';
                ctx.beginPath();
                ctx.drawImage(imagens['Meteoro 3'], this.x, this.y, 120, 68);
                // ctx.arc(this.x, this.y, this.R, 0, 2 * Math.PI);
                // ctx.fill();
            }

            update(){
                if (this.x < 0 - this.R) this.x = W + this.R
                if (this.x > W + this.R) this.x = 0 - this.R
                if (this.y < 0 - this.R)  this.y = H + this.R
                if (this.y > H + this.R) this.y = 0 - this.R

                this.x += this.dX;
                this.y += this.dY;
            }
        }

        let a = [];
        for (let i = 0; i < 10; i++) {
            let R = Math.floor(Math.random() * 256);
            let G = Math.floor(Math.random() * 256);
            let B = Math.floor(Math.random() * 256);
            let color = `rgb(${R},${G},${B})`;

            let xInit = 20 + Math.random() * (W - 2 * 20);
            let yInit = 20 + Math.random() * (H - 2 * 20);

            let direction = Math.random() * 2 * Math.PI;

            a.push(new Asteroides(xInit, yInit, 10, direction, color))
        }

        function render(e){
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            //mover a nave
            if (upKey) {
                y -= 3;
                if (y < 0 - R){
                    y = H + R;
                }
            }
            if (downKey) {
                y += 3;
                if (y > H + R){
                    y = 0 - R;
                }
            }
            if (leftKey) {
                x -= 3;
                if (x < 0 - R){
                    x = W + R;
                }
            }
            if (rightKey) {
                x += 3;
                if (x > W + R){
                    x = 0 - R;
                }
            }
            if (space){
                teleport()
                space = false;
            }

            if (click && tiroTimer){
                tiros.push(new Tiro(x+15, y, 'White', 5, xR, yR))
                tiroTimer = false;
                timeTiro = window.setInterval(timerTiro, 500)
            }

            ctx.beginPath();
            ctx.drawImage(imagens['Nave'], x, y, 35, 69)
            // ctx.arc(x, y, R, 0, Math.PI * 2);
            // ctx.fill();

            //mover os asteroides
            a.forEach( asteroide => {
                asteroide.draw();
                asteroide.update();
            });

            tiros.forEach(tiro =>{
                tiro.draw();
                tiro.update();
            })

            window.requestAnimationFrame(render);
        }

        //disparo
        class Tiro{
            constructor(x, y, c, t, xDir, yDir){
                this.x = x;
                this.y = y;
                this.c = c;
                this.t = t;
                this.xDir = xDir;
                this.yDir = yDir;
            }

            draw(){
                ctx.fillStyle = this.c;
                ctx.beginPath();
                ctx.fillRect(this.x, this.y, this.t, this.t);
            }

            update(){
                if(this.xDir < this.x){
                    this.x -= 2;
                }
                if (this.xDir > this.x) {
                    this.x += 2;
                }
                if (this.yDir < this.y) {
                    this.y -= 2;
                }
                if (this.yDir > this.y) {
                    this.y += 2;
                }

                if (this.xDir == this.x && this.yDir == this.y) {
                    tiros.shift();
                }

                console.log(`xDir: ${this.xDir}; x: ${this.x}`);
                console.log(`xDir: ${this.yDir}; x: ${this.y}`);
            }
        }

        let tiros = [];

        function timerTiro(){
            tiroTimer = true;
            window.clearInterval(timeTiro);
        }

        //full screen
        function fullscreen(){
                var el = document.getElementById('canvas');

                if(el.webkitRequestFullScreen) {
                el.webkitRequestFullScreen();
                }
                else {
                    el.mozRequestFullScreen();
                }      
        }
        
        function ecraInicial(){
            let text = 'ENTER'
            ctx.font = '50px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text, x, y)

            window.addEventListener('Enter', render)
        }

        ecraInicial()

        canvas.addEventListener('mousedown', (e) => {
            click = true
            xR = e.clientX;
            yR = e.clientY;
        })

        canvas.addEventListener('mouseup', () =>{
            click = false;
        } )
    </script>
</body>

</html>